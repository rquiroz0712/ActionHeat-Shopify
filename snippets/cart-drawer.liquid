{% if settings.cart_type == 'drawer' %}
  <div id="CartDrawer" class="drawer drawer--right">
    <form id="CartDrawerForm" action="{{ routes.cart_url }}" method="post" novalidate class="drawer__contents">
      <div class="drawer__fixed-header">
        <div class="drawer__header appear-animation appear-delay-1">
          <div class="drawer__title">{{ 'cart.general.title' | t }}</div>
          <div class="drawer__close">
            <button type="button" class="drawer__close-button js-drawer-close">
              <svg aria-hidden="true" focusable="false" role="presentation" class="icon icon-close" viewBox="0 0 64 64"><path d="M19 17.61l27.12 27.13m0-27.12L19 44.74"/></svg>
              <span class="icon__fallback-text">{{ 'cart.general.close_cart' | t }}</span>
            </button>
          </div>
        </div>
      </div>

      <div class="drawer__inner">
        <div class="drawer__scrollable">
          <div data-products class="appear-animation appear-delay-2"></div>

          {% if settings.cart_notes_enable %}
            <div class="appear-animation appear-delay-3">
              <label for="CartNoteDrawer">{{ 'cart.general.note' | t }}</label>
              <textarea name="note" class="input-full cart-notes" id="CartNoteDrawer">{{ cart.note }}</textarea>
            </div>
          {% endif %}
        </div>

        <div class="drawer__footer appear-animation appear-delay-4">
          <div data-discounts>
            {% if cart.cart_level_discount_applications != blank %}
              <div class="cart__item-sub cart__item-row">
                <div>{{ 'cart.general.discounts' | t }}</div>
                <div class="text-right">
                  {% for cart_discount in cart.cart_level_discount_applications %}
                    <div>
                      {{ cart_discount.title }} (-{{ cart_discount.total_allocated_amount | money }})
                    </div>
                  {% endfor %}
                </div>
              </div>
            {% endif %}
          </div>

          <div class="cart__item-sub cart__item-row">
            <div class="cart__subtotal">{{ 'cart.general.subtotal' | t }}</div>
            <span style="display: block; text-align: right;" class="saw-extra-note"></span><span class="saw-cart-original-total"><div data-subtotal>{{ cart.total_price | money }}</div></span><br><span class="saw-cart-total"></span>
          </div>

          <div class="cart__item-row cart__savings text-center hide" data-savings></div>

          <div class="cart__item-row text-center ajaxcart__note">
            <small>
              {{ 'cart.general.shipping_at_checkout' | t }}<br />
            </small>
          </div>

          {% if settings.cart_terms_conditions_enable %}
            <div class="cart__item-row cart__terms">
              <input type="checkbox" id="CartTermsDrawer" class="cart__terms-checkbox">
              <label for="CartTermsDrawer">
                {% if settings.cart_terms_conditions_page != blank %}
                  {{ 'cart.general.terms_html' | t: url: settings.cart_terms_conditions_page.url }}
                {% else %}
                  {{ 'cart.general.terms' | t }}
                {% endif %}
              </label>
            </div>
          {% endif %}

          <!-- Route App -->
          <div class="route-div" desktop-align="center" style="margin-bottom: -15px; margin-top: -15px"></div>
          <div style="font-size: 12px; margin-top: -10px; margin-bottom: 15px; text-align: center;">*By deselecting shipping protection, Action Heat<br> is not liable for lost, damaged, or stolen items</div>
          <!-- END Route App -->
          
          <div class="cart__checkout-wrapper">
            <a href="/cart" class="btn btn--full add-to-cart">Go to cart</a>
          </div>
        </div>
      </div>

      <div class="drawer__cart-empty appear-animation appear-delay-2">
        <div class="drawer__scrollable">
          {{ 'cart.general.empty' | t }}
        </div>
      </div>
    </form>
  </div>

  <script type="text/javascript">
    window.onload = function() {
        const config = { childList: true, subtree: true };
        const targetNode = document.querySelector("#CartDrawer .drawer__inner .drawer__scrollable");
        let cartDrawerTotalDiv = document.querySelector("#CartDrawer .saw-cart-original-total > div");

        const callbackCartDrawer = (mutationList, observer) => {
            for (const mutation of mutationList) {
                if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                    let originalPrices = 0;
                    let discountPrices = 0;
                    let cartItems = document.querySelectorAll("#CartDrawer .cart__item");
                    [...cartItems].forEach((item) => {
                        let quantity = item.querySelector(".cart__item--qty .js-qty__wrapper > input").value;
                        let originalPrice = (item.querySelector(".cart__price:not(.cart__discount):not(.cart__price--strikethrough)")) ? parseFloat(item.querySelector(".cart__price:not(.cart__discount)").innerHTML.split('$')[1]) : 0;
                        let discountPrice = (item.querySelector(".cart__price.saw__price")) ? parseFloat(item.querySelector(".cart__price.saw__price").innerHTML.split('$')[1]) : 0;
                        originalPrices += (originalPrice * quantity);
                        discountPrices += (discountPrice * quantity);
                    });
                    document.querySelector(".saw-cart-original-total > div").innerHTML = `$${originalPrices + discountPrices}`;
                }
            }
        };

        const observerCartDrawer = new MutationObserver(callbackCartDrawer);
        observerCartDrawer.observe(targetNode, config);
    }
  </script>
{% endif %}
